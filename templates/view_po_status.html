{% extends 'base.html' %}
{% block title %}Purchase Order Status{% endblock %}

{% block content %}
<style>
    .page-header h1 {
        font-weight: 700;
    }
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }
    .card-header {
        background-color: #ffffff;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-bottom-width: 2px;
        font-weight: 600;
        white-space: nowrap;
    }
    .table td, .table th {
        vertical-align: middle;
    }
    .badge {
        font-size: 85%;
        font-weight: 600;
        padding: 0.4em 0.7em;
    }
    .action-buttons a {
        margin: 0 3px;
    }
</style>

<div class="page-header">
    <h1>Purchase Order Status</h1>
    <p class="text-muted">Track and manage all company purchase orders.</p>
</div>
<div>
        <a href="{{ url_for('register_po') }}" class="btn btn-success">
            <i class="fas fa-plus mr-2"></i>Register New PO
        </a>
</div>

<div class="card">
    <div class="card-header"><i class="fas fa-filter mr-2"></i>Filter Purchase Orders</div>
    <div class="card-body">
        <form method="POST">
            <div class="form-row">
                <div class="form-group col-md-4"><label>Project Name</label>
                    <select class="form-control" name="project_name">
                        <option value="">All</option>
                        {% for project in projects %}<option value="{{ project[0] }}" {% if project[0] == project_name_filter %}selected{% endif %}>{{ project[1] }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4"><label>Presale Engineer</label>
                    <select class="form-control" name="presale_engineer">
                        <option value="">All</option>
                        {% for engineer in presale_engineers %}<option value="{{ engineer[0] }}" {% if engineer[0] == presale_engineer_filter %}selected{% endif %}>{{ engineer[0] }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4"><label>Project Manager</label>
                    <select class="form-control" name="project_manager">
                        <option value="">All</option>
                        {% for manager in project_managers %}<option value="{{ manager[0] }}" {% if manager[0] == project_manager_filter %}selected{% endif %}>{{ manager[0] }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4"><label>Distributor</label>
                    <select class="form-control" name="distributor">
                        <option value="">All</option>
                        {% for d in distributors %}<option value="{{ d[0] }}" {% if d[0] == distributor_filter %}selected{% endif %}>{{ d[0] }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-4"><label>Delivery Status</label>
                    <select class="form-control" name="po_delivery_status">
                        <option value="">All</option>
                        <option value="Order Not Placed" {% if po_delivery_status_filter == 'Order Not Placed' %}selected{% endif %}>Order Not Placed</option>
                        <option value="Order Placed" {% if po_delivery_status_filter == 'Order Placed' %}selected{% endif %}>Order Placed</option>
                        <option value="Delivered To Client" {% if po_delivery_status_filter == 'Delivered To Client' %}selected{% endif %}>Delivered To Client</option>
                        </select>
                </div>
                 <div class="form-group col-md-4"><label>Approval Status</label>
                    <select class="form-control" name="po_approval_status">
                        <option value="">All</option>
                        <option value="Pending" {% if po_approval_status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                        <option value="Approved" {% if po_approval_status_filter == 'Approved' %}selected{% endif %}>Approved</option>
                        <option value="Rejected" {% if po_approval_status_filter == 'Rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-search mr-1"></i>Apply</button>
            <a href="{{ url_for('view_po_status') }}" class="btn btn-secondary"><i class="fas fa-times mr-1"></i>Clear</a>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list-ul mr-2"></i>Purchase Order Details</span>
        <form action="{{ url_for('download_filtered_po_excel') }}" method="GET">
            <input type="hidden" name="presale_engineer" value="{{ presale_engineer_filter }}">
            <input type="hidden" name="project_manager" value="{{ project_manager_filter }}">
            <input type="hidden" name="distributor" value="{{ distributor_filter }}">
            <input type="hidden" name="po_delivery_status" value="{{ po_delivery_status_filter }}">
            <input type="hidden" name="po_approval_status" value="{{ po_approval_status_filter }}">
            <button type="submit" class="btn btn-success btn-sm"><i class="fas fa-file-excel mr-1"></i>Download Excel</button>
        </form>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>PO Request Num</th>
                        <th>PO Number</th>
                        <th>Project Name</th>
                        <th>System</th>
                        <th>Distributor</th>
                        <th>Approval Status</th>
                        <th>Delivery Status</th>
                        <th>Project Manager</th>
                        <th>Total Amount (SAR)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in purchase_orders %}
                    <tr>
                        <td>{{ order[1] }}</td>
                        <td><a href="{{ url_for('view_po_details', po_number=order[8]) }}" class="btn btn-outline-primary btn-sm">{{ order[8] }}</a></td>
                         <td>{{ order[2] }}</td>
                        <td>{{ order[12] }}</td>
                        <td>{{ order[3] }}</td>
                        <td>
                            {% set status = order[4] %}
                            {% if status == 'Approved' %}<span class="badge badge-success">{{ status }}</span>
                            {% elif status == 'Pending' %}<span class="badge badge-warning">{{ status }}</span>
                            {% elif status == 'Rejected' %}<span class="badge badge-danger">{{ status }}</span>
                            {% else %}<span class="badge badge-secondary">{{ status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set d_status = order[5] %}
                            {% if 'Completed' in d_status or 'Delivered' in d_status %}<span class="badge badge-success">{{ d_status }}</span>
                            {% elif 'Placed' in d_status %}<span class="badge badge-info">{{ d_status }}</span>
                            {% elif 'Returned' in d_status %}<span class="badge badge-danger">{{ d_status }}</span>
                            {% else %}<span class="badge badge-light">{{ d_status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ order[7] }}</td>
                        <td>{{ "{:,.2f}".format(order[11]) }}</td>
                        <td class="action-buttons">

                            <a href="{{ url_for('view_po_document', po_id=order[0], doc_type='po_document') }}" target="_blank" class="btn btn-info btn-sm" title="Show PO">
                                <i class="fas fa-eye"></i>
                            </a>

                            <a href="{{ url_for('view_po_document', po_id=order[0], doc_type='quotation') }}" target="_blank" class="btn btn-secondary btn-sm" title="Show Quotation">
                                <i class="fas fa-file-alt"></i>
                            </a>
                            <a href="{{ url_for('edit_po', po_id=order[0]) }}" class="btn btn-warning btn-sm" title="Edit PO"><i class="fas fa-edit"></i></a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="9" class="text-center text-muted py-5">No Purchase Orders found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}