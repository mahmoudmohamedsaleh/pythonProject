{% extends "base.html" %}

{% block title %}Hikvision Product Selector{% endblock %}

{% block content %}
<style>
    .hikvision-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .hikvision-header {
        background: linear-gradient(135deg, #E63946 0%, #C62936 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(230, 57, 70, 0.3);
    }
    
    .hikvision-header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5em;
        font-weight: 700;
    }
    
    .hikvision-header p {
        margin: 0;
        font-size: 1.1em;
        opacity: 0.95;
    }
    
    .filter-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .filter-section h3 {
        color: #E63946;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.3em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: #333;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-group select, .filter-group input {
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1em;
        transition: all 0.3s ease;
        background: white;
    }
    
    .filter-group select:focus, .filter-group input:focus {
        outline: none;
        border-color: #E63946;
        box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .btn-filter {
        background: #E63946;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-filter:hover {
        background: #C62936;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
    }
    
    .btn-reset {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-reset:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .btn-sync {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-sync:hover {
        background: #218838;
        transform: translateY(-2px);
    }
    
    .product-stats {
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .product-stats div {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1em;
    }
    
    .product-stats strong {
        color: #E63946;
        font-size: 1.3em;
    }
    
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .product-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(230, 57, 70, 0.15);
    }
    
    .product-image {
        width: 100%;
        height: 200px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .product-image img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
    }
    
    .product-image-placeholder {
        font-size: 4em;
        color: #ccc;
    }
    
    .product-info {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .product-model {
        font-weight: 700;
        font-size: 1.05em;
        color: #E63946;
        margin-bottom: 8px;
        line-height: 1.3;
    }
    
    .product-description {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 12px;
        line-height: 1.4;
        flex-grow: 1;
    }
    
    .product-specs {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: auto;
    }
    
    .spec-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 600;
        color: #555;
    }
    
    .spec-badge.resolution {
        background: #E63946;
        color: white;
    }
    
    .spec-badge.case-type {
        background: #007bff;
        color: white;
    }
    
    .spec-badge.colorvu {
        background: #ffc107;
        color: #333;
    }
    
    .no-products {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .no-products h3 {
        color: #666;
        font-size: 1.5em;
        margin-bottom: 15px;
    }
    
    .sync-info {
        background: #e7f3ff;
        padding: 12px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #0066cc;
    }
    
    @media (max-width: 768px) {
        .filter-grid {
            grid-template-columns: 1fr;
        }
        
        .products-grid {
            grid-template-columns: 1fr;
        }
        
        .hikvision-header h1 {
            font-size: 1.8em;
        }
    }
</style>

<div class="hikvision-container">
    <!-- Header -->
    <div class="hikvision-header">
        <h1>üé• Hikvision Product Selector</h1>
        <p>Find the right Hikvision products for your security needs - Synced from official Hikvision catalog</p>
    </div>
    
    <!-- Sync Info -->
    {% if last_sync %}
    <div class="sync-info">
        üìÖ Last synchronized: {{ last_sync }} 
        {% if user_role in ['General Manager', 'Technical Team Leader'] %}
        | <button class="btn-sync" onclick="syncHikvisionProducts()">üîÑ Sync Now</button>
        {% endif %}
    </div>
    {% else %}
    <div class="sync-info" style="background: #fff3cd; border-color: #ffc107;">
        ‚ö†Ô∏è No products synced yet. 
        {% if user_role in ['General Manager', 'Technical Team Leader'] %}
        <button class="btn-sync" onclick="syncHikvisionProducts()">üîÑ Sync from Hikvision</button>
        {% else %}
        Please contact your administrator to sync products.
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Filters -->
    <form method="GET" action="{{ url_for('hikvision_selector') }}">
        <div class="filter-section">
            <h3>üîç Filter Products</h3>
            
            <div class="filter-grid">
                <!-- Case Type -->
                <div class="filter-group">
                    <label>Case Type</label>
                    <select name="case_type">
                        <option value="all">All Types</option>
                        {% for ct in case_types %}
                        <option value="{{ ct }}" {% if request.args.get('case_type') == ct %}selected{% endif %}>{{ ct }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Resolution -->
                <div class="filter-group">
                    <label>Resolution</label>
                    <select name="resolution">
                        <option value="all">All Resolutions</option>
                        {% for res in resolutions %}
                        <option value="{{ res }}" {% if request.args.get('resolution') == res %}selected{% endif %}>{{ res }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Lens Type -->
                <div class="filter-group">
                    <label>Lens Type</label>
                    <select name="lens_type">
                        <option value="all">All Lens Types</option>
                        {% for lt in lens_types %}
                        <option value="{{ lt }}" {% if request.args.get('lens_type') == lt %}selected{% endif %}>{{ lt }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Low-Light Imaging -->
                <div class="filter-group">
                    <label>Low-Light Imaging</label>
                    <select name="low_light_imaging">
                        <option value="all">All Technologies</option>
                        {% for ll in low_light_options %}
                        <option value="{{ ll }}" {% if request.args.get('low_light_imaging') == ll %}selected{% endif %}>{{ ll }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Power Supply -->
                <div class="filter-group">
                    <label>Power Supply</label>
                    <select name="power_supply">
                        <option value="all">All Power Options</option>
                        {% for ps in power_supplies %}
                        <option value="{{ ps }}" {% if request.args.get('power_supply') == ps %}selected{% endif %}>{{ ps }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Supplemental Light -->
                <div class="filter-group">
                    <label>Supplemental Light</label>
                    <select name="supplemental_light">
                        <option value="all">All Light Types</option>
                        {% for sl in supplemental_lights %}
                        <option value="{{ sl }}" {% if request.args.get('supplemental_light') == sl %}selected{% endif %}>{{ sl }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- WDR -->
                <div class="filter-group">
                    <label>WDR</label>
                    <select name="wdr">
                        <option value="all">All WDR Options</option>
                        {% for w in wdr_options %}
                        <option value="{{ w }}" {% if request.args.get('wdr') == w %}selected{% endif %}>{{ w }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Wireless Network -->
                <div class="filter-group">
                    <label>Wireless Network</label>
                    <select name="wireless_network">
                        <option value="all">All Wireless Options</option>
                        {% for wn in wireless_options %}
                        <option value="{{ wn }}" {% if request.args.get('wireless_network') == wn %}selected{% endif %}>{{ wn }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Search -->
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" name="search" placeholder="Model number, name..." value="{{ request.args.get('search', '') }}">
                </div>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn-filter">
                    <span>üîç</span>
                    <span>Apply Filters</span>
                </button>
                <button type="button" class="btn-reset" onclick="window.location.href='{{ url_for('hikvision_selector') }}'">
                    Reset All
                </button>
            </div>
        </div>
    </form>
    
    <!-- Product Stats -->
    <div class="product-stats">
        <div>
            <span>üì¶ Showing:</span>
            <strong>{{ filtered_count }}</strong>
            <span>of {{ total_products }} products</span>
        </div>
    </div>
    
    <!-- Products Grid -->
    {% if products %}
    <div class="products-grid">
        {% for product in products %}
        <div class="product-card">
            <div class="product-image">
                {% if product[18] %}
                <img src="{{ product[18] }}" alt="{{ product[1] }}" onerror="this.parentElement.innerHTML='<div class=product-image-placeholder>üì∑</div>'">
                {% else %}
                <div class="product-image-placeholder">üì∑</div>
                {% endif %}
            </div>
            <div class="product-info">
                <div class="product-model">{{ product[1] }}</div>
                <div class="product-description">
                    {{ product[3] if product[3] else 'Hikvision ' + product[4] + ' Camera' }}
                </div>
                <div class="product-specs">
                    {% if product[5] != 'N/A' %}
                    <span class="spec-badge resolution">{{ product[5] }}</span>
                    {% endif %}
                    {% if product[4] != 'N/A' %}
                    <span class="spec-badge case-type">{{ product[4] }}</span>
                    {% endif %}
                    {% if 'ColorVu' in product[10] %}
                    <span class="spec-badge colorvu">ColorVu</span>
                    {% endif %}
                    {% if product[11] and product[11] != 'N/A' %}
                    <span class="spec-badge">{{ product[11] }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-products">
        <h3>üîç No products found</h3>
        <p>Try adjusting your filters or <a href="{{ url_for('hikvision_selector') }}">reset all filters</a></p>
        {% if not last_sync %}
        <p style="margin-top: 20px;">
            <button class="btn-sync" onclick="syncHikvisionProducts()">üîÑ Sync from Hikvision</button>
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function syncHikvisionProducts() {
    if (!confirm('This will fetch the latest products from Hikvision website. This may take a few minutes. Continue?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Syncing...';
    
    fetch('/api/hikvision/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Success! Synced ${data.synced_count} products from Hikvision.`);
            location.reload();
        } else {
            alert(`‚ùå Error: ${data.error}`);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert(`‚ùå Error: ${error.message}`);
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}
</script>

{% endblock %}
