{% extends 'base.html' %}
{% block title %}Task Management{% endblock %}

{% block content %}
<style>
    .kanban-board { display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem; }
    .kanban-column { flex: 1; min-width: 320px; background-color: #f8f9fa; border-radius: 8px; padding: 1rem; }
    .kanban-column-header { font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e9ecef; }
    .task-card { background-color: #fff; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #6c757d; }
    .task-card.priority-High { border-left-color: #dc3545; }
    .task-card.priority-Medium { border-left-color: #ffc107; }
    .task-card.priority-Low { border-left-color: #28a745; }
    .task-card-title { font-weight: bold; }
    .task-card-meta { font-size: 0.8rem; color: #6c757d; }
    .task-card-actions { margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .comment-history-item { border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
    .comment-history-item:last-child { border-bottom: none; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Task Management</h1>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newTaskModal"><i class="fas fa-plus mr-2"></i>New Task</button>
</div>

<form method="GET" action="{{ url_for('tasks') }}" class="card card-body mb-4">
    <div class="form-row align-items-end">
        <div class="form-group col-md-2"><label for="created_from" class="small">Created From</label><input type="date" class="form-control form-control-sm" name="created_from" value="{{ current_filters.created_from }}"></div>
        <div class="form-group col-md-2"><label for="created_to" class="small">Created To</label><input type="date" class="form-control form-control-sm" name="created_to" value="{{ current_filters.created_to }}"></div>
        <div class="form-group col-md-2"><label for="due_from" class="small">Due From</label><input type="date" class="form-control form-control-sm" name="due_from" value="{{ current_filters.due_from }}"></div>
        <div class="form-group col-md-2"><label for="due_to" class="small">Due To</label><input type="date" class="form-control form-control-sm" name="due_to" value="{{ current_filters.due_to }}"></div>
        <div class="form-group col-md-2"><label for="assigned_to_filter" class="small">Assigned To</label><select name="assigned_to_filter" class="form-control form-control-sm"><option value="">All Users</option>{% for user in filter_assignee_list %}<option value="{{ user.id }}" {% if current_filters.assigned_to_filter == user.id|string %}selected{% endif %}>{{ user.username }}</option>{% endfor %}</select></div>
        <div class="form-group col-md-2"><button type="submit" class="btn btn-sm btn-info btn-block">Filter</button><a href="{{ url_for('tasks') }}" class="btn btn-sm btn-secondary btn-block mt-1">Clear</a></div>
    </div>
</form>

<div class="kanban-board">
    {% set statuses = ['To Do', 'In Progress', 'Done'] %}
    {% for status in statuses %}
    <div class="kanban-column">
        <div class="kanban-column-header d-flex justify-content-between align-items-center">
            <span>{{ status }}</span>
            <span class="badge badge-pill badge-secondary">
                {{ (tasks|selectattr('status', 'equalto', status)|list|length) }}
            </span>
        </div>
        <div class="kanban-tasks">
            {% for task in tasks if task.status == status %}
            <div class="task-card priority-{{ task.priority }}">
                <div class="task-card-title">{{ task.title }}</div>
                <p class="small text-muted">{{ task.description }}</p>
                <div class="task-card-meta mt-2">
                    <div><strong>To:</strong> {{ task.assigned_to_name }}</div>
                    <div><strong>From:</strong> {{ task.assigned_by_name }}</div>
                    <div><strong>Due:</strong> {{ task.due_date if task.due_date else 'N/A' }}</div>
                </div>
                <div class="task-card-actions">
                    <select class="form-control form-control-sm status-select" data-task-id="{{ task.id }}" data-current-status="{{ task.status }}">
                        {% for s in statuses %}<option value="{{ s }}" {% if s == task.status %}selected{% endif %}>{{ s }}</option>{% endfor %}
                    </select>
                    <div class="mt-2 text-right">
                        <button type="button" class="btn btn-sm btn-outline-primary add-comment" data-task-id="{{ task.id }}" title="Add Comment"><i class="fas fa-comment-dots"></i></button>
                        <button type="button" class="btn btn-sm btn-outline-secondary view-comments" data-task-id="{{ task.id }}" title="View History"><i class="fas fa-history"></i></button>
                        {% if task.assigned_by_id == current_user_id or user_role == 'General Manager' %}
                        <form action="{{ url_for('delete_task', task_id=task.id) }}" method="POST" onsubmit="return confirm('Are you sure?');" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Task"><i class="fas fa-trash"></i></button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><form method="POST" action="{{ url_for('tasks') }}"><div class="modal-header"><h5 class="modal-title">Create New Task</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body"><div class="form-group"><label>Title</label><input type="text" class="form-control" name="title" required></div><div class="form-group"><label>Description</label><textarea class="form-control" name="description" rows="3"></textarea></div><div class="form-row"><div class="form-group col-md-6"><label>Assign To</label><select name="assigned_to_id" class="form-control" required><option value="" disabled selected>Choose user...</option>{% for user in assignable_users %}<option value="{{ user.id }}">{{ user.username }} ({{ user.role }})</option>{% endfor %}</select></div><div class="form-group col-md-6"><label>Priority</label><select name="priority" class="form-control"><option value="Low">Low</option><option value="Medium" selected>Medium</option><option value="High">High</option></select></div></div><div class="form-group"><label>Due Date</label><input type="date" class="form-control" name="due_date"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Create Task</button></div></form></div></div></div>

<div class="modal fade" id="commentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document"><div class="modal-content"><form method="POST" action="{{ url_for('update_task_with_comment') }}"><div class="modal-header"><h5 class="modal-title">Add Comment for Status Change</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body"><input type="hidden" name="task_id" id="comment_task_id"><input type="hidden" name="new_status" id="comment_new_status"><div class="form-group"><label for="comment">Comment (Required)</label><textarea class="form-control" id="comment" name="comment" rows="4" required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Status Change</button></div></form></div></div>
</div>

<div class="modal fade" id="addCommentOnlyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_task_comment') }}">
                <div class="modal-header"><h5 class="modal-title">Add Progress Comment</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
                <div class="modal-body">
                    <input type="hidden" name="task_id" id="add_comment_task_id">
                    <div class="form-group">
                        <label for="progress_comment">Comment</label>
                        <textarea class="form-control" id="progress_comment" name="comment" rows="4" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Comment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-scrollable" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Task History</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body" id="historyModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button></div></div></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Handle Status Change ---
    const statusSelects = document.querySelectorAll('.status-select');
    statusSelects.forEach(select => {
        select.addEventListener('change', function (e) {
            const newStatus = e.target.value, currentStatus = e.target.dataset.currentStatus, taskId = e.target.dataset.taskId;
            if (newStatus === currentStatus) return;
            document.getElementById('comment_task_id').value = taskId;
            document.getElementById('comment_new_status').value = newStatus;
            $('#commentModal').modal('show');
            $('#commentModal').on('hidden.bs.modal', () => e.target.value = currentStatus);
        });
    });

    // --- Handle Viewing Comment History ---
    const viewButtons = document.querySelectorAll('.view-comments');
    const historyBody = document.getElementById('historyModalBody');
    viewButtons.forEach(button => {
        button.addEventListener('click', function () {
            const taskId = this.dataset.taskId;
            historyBody.innerHTML = '<p>Loading history...</p>';
            $('#historyModal').modal('show');
            fetch(`/get_task_comments/${taskId}`).then(res => res.json()).then(comments => {
                if (comments.length === 0) { historyBody.innerHTML = '<p>No history found.</p>'; return; }
                let html = '';
                comments.forEach(c => {
                    html += `<div class="comment-history-item"><p class="mb-1">${c.comment}</p><small class="text-muted">By <strong>${c.username}</strong> on ${c.created_at}</small></div>`;
                });
                historyBody.innerHTML = html;
            }).catch(err => { historyBody.innerHTML = '<p class="text-danger">Failed to load history.</p>'; });
        });
    });

    // --- Handle Adding a Comment without Status Change ---
    const addCommentButtons = document.querySelectorAll('.add-comment');
    addCommentButtons.forEach(button => {
        button.addEventListener('click', function () {
            const taskId = this.dataset.taskId;
            document.getElementById('add_comment_task_id').value = taskId;
            document.getElementById('progress_comment').value = ''; // Clear previous text
            $('#addCommentOnlyModal').modal('show');
        });
    });
});
</script>
{% endblock %}