{% extends 'base.html' %}
{% block title %}Technical Support Summary{% endblock %}

{% block content %}
<style>
    .page-header h1 {
        font-weight: 700;
    }
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }
    .card-header {
        background-color: #ffffff;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-bottom-width: 2px;
        font-weight: 600;
        white-space: nowrap;
    }
    .table td, .table th {
        vertical-align: middle;
    }
</style>

<div class="page-header">
    <h1>Technical Support Summary</h1>
    <p class="text-muted">An overview of all RFTS requests.</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header"><i class="fas fa-filter mr-2"></i>Filter Requests</div>
            <div class="card-body">
                <form method="GET">
                    <div class="form-row">
                        <div class="form-group col-md-4"><label>Presale Engineer</label><select name="presale_engineer" class="form-control"><option value="">All</option>{% for e in presale_engineers %}<option value="{{ e }}">{{ e }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-4"><label>Sales Engineer</label><select name="sales_engineer" class="form-control"><option value="">All</option>{% for e in sales_engineers %}<option value="{{ e }}">{{ e }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-4"><label>Request Type</label><select name="request_type" class="form-control"><option value="">All</option>{% for t in request_types %}<option value="{{ t }}">{{ t }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-4"><label>Request Status</label><select name="request_status" class="form-control"><option value="">All</option>{% for s in request_statuses %}<option value="{{ s }}">{{ s }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-4"><label>Priority</label><select name="priority" class="form-control"><option value="">All</option>{% for p in priorities %}<option value="{{ p }}">{{ p }}</option>{% endfor %}</select></div>
                    </div>
                    <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-search mr-1"></i>Apply</button>
                    <a href="{{ url_for('technical_support_summary') }}" class="btn btn-secondary"><i class="fas fa-times mr-1"></i>Clear</a>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-chart-pie mr-2"></i>Status Distribution</span>
                <span class="badge badge-primary badge-pill">{{ total_requests }} Total</span>
            </div>
            <div class="card-body"><canvas id="requestStatusChart"></canvas></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list-ul mr-2"></i>Request Details</span>
        <a href="{{ url_for('download_filtered_technical_support', request_type=request.args.get('request_type'), request_status=request.args.get('request_status'), priority=request.args.get('priority'), presale_engineer=request.args.get('presale_engineer'), sales_engineer=request.args.get('sales_engineer')) }}" class="btn btn-success btn-sm"><i class="fas fa-file-excel mr-1"></i>Download</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Reference</th><th>Type</th><th>Project Name</th><th>Priority</th><th>Presale Eng.</th>
                        <th>Sales Eng.</th><th>Status</th><th>Result</th><th>Deadline</th><th>Requested Time</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        <td>{{ req[1] }}</td><td>{{ req[2] }}</td><td>{{ req[3] }}</td><td>{{ req[4] }}</td>
                        <td>{{ req[5] }}</td><td>{{ req[6] }}</td><td>{{ req[7] }}</td><td>{{ req[8] }}</td>
                        <td>{{ req[9] }}</td><td>{{ req[11].split(' ')[0] }}</td>
                        <td>
                            <a href="{{ url_for('edit_request', request_id=req[0]) }}" class="btn btn-warning btn-sm"><i class="fas fa-edit"></i> Edit</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="11" class="text-center text-muted py-5">No requests found matching your criteria.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    Chart.register(ChartDataLabels);
    const ctx = document.getElementById('requestStatusChart').getContext('2d');
    const requestStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ status_labels|tojson }},
            datasets: [{
                data: {{ status_counts|tojson }},
                backgroundColor: ['#007bff', '#ffc107', '#28a745', '#dc3545', '#6c757d', '#17a2b8'],
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                datalabels: {
                    formatter: (value, ctx) => value,
                    color: '#fff',
                    font: { weight: 'bold', size: 14 }
                },
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 20 }
                }
            }
        }
    });
</script>
{% endblock %}