{% extends 'base.html' %}
{% block title %}RFQ Dashboard{% endblock %}

{% block content %}
<style>
    .page-header h1 { font-weight: 700; }
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 30px; }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 600; }
    .table thead th { background-color: #f8f9fa; border-bottom-width: 2px; font-weight: 600; white-space: nowrap; }
    .table td, .table th { vertical-align: middle; }
    .action-buttons a, .action-buttons form, .action-buttons button {
        margin: 0 2px;
        display: inline-block;
    }
    .comment-history {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
    }
    .comment-item {
        background-color: #ffffff;
        border-left: 4px solid #007bff;
        padding: 12px 15px;
        margin-bottom: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .comment-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    .comment-time {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: normal;
    }
    .comment-text {
        color: #212529;
        line-height: 1.6;
        white-space: pre-wrap;
    }
</style>

<div class="page-header">
    <h1>RFQ Dashboard</h1>
    <p class="text-muted">An overview and detailed list of all Requests for Quotation.</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header"><i class="fas fa-filter mr-2"></i>Filter RFQs</div>
            <div class="card-body">
                <form method="GET">
                    <div class="form-row">
                        <div class="form-group col-md-6"><label>Pre-Sales Engineer</label><select name="presale_engineer" class="form-control"><option value="">All</option>{% for e in presale_engineers %}<option value="{{ e }}" {% if current_filters.presale_engineer == e %}selected{% endif %}>{{ e }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-6"><label>Sales Engineer</label><select name="sales_engineer" class="form-control"><option value="">All</option>{% for e in sales_engineers %}<option value="{{ e }}" {% if current_filters.sales_engineer == e %}selected{% endif %}>{{ e }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-6"><label>RFQ Status</label><select name="rfq_status" class="form-control"><option value="">All</option>{% for s in rfq_status_options %}<option value="{{ s }}" {% if current_filters.rfq_status == s %}selected{% endif %}>{{ s }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-6"><label>Quotation Status</label><select name="quotation_status" class="form-control"><option value="">All</option>{% for s in quotation_status_options %}<option value="{{ s }}" {% if current_filters.quotation_status == s %}selected{% endif %}>{{ s }}</option>{% endfor %}</select></div>
                        <div class="form-group col-md-6"><label>Requested From</label><input type="date" class="form-control" name="start_date" value="{{ current_filters.start_date or '' }}"></div>
                        <div class="form-group col-md-6"><label>Requested To</label><input type="date" class="form-control" name="end_date" value="{{ current_filters.end_date or '' }}"></div>
                    </div>
                     <button type="submit" class="btn btn-primary mr-2"><i class="fas fa-search mr-1"></i>Apply</button>
                     <a href="{{ url_for('rfq_summary') }}" class="btn btn-secondary"><i class="fas fa-times mr-1"></i>Clear</a>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-chart-pie mr-2"></i>Status Distribution</span>
                <span class="badge badge-primary badge-pill">{{ total_rfqs }} Total</span>
            </div>
            <div class="card-body"><canvas id="rfqStatusChart"></canvas></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-list-ul mr-2"></i>RFQ Details</span>
        <div>
            <div class="btn-group btn-group-sm mr-2" role="group">
                <a href="{{ url_for('rfq_summary') }}" class="btn btn-primary active">
                    <i class="fas fa-table mr-1"></i> Table View
                </a>
                <a href="{{ url_for('rfq_pipeline') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-stream mr-1"></i> Pipeline View
                </a>
            </div>
            <a href="{{ url_for('download_filtered_rfqs', **request.args) }}" class="btn btn-success btn-sm"><i class="fas fa-file-excel mr-1"></i>Download Excel</a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>RFQ Reference</th><th>Quotation Reference</th><th>Project Name</th><th>Priority</th>
                        <th>Presale Eng.</th><th>Sales Eng.</th><th>RFQ Status</th><th>Quotation Status</th>
                        <th>Deadline</th><th>Requested Time</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rfq in rfqs %}
                    <tr>
                        <td>{{ rfq[1] }}</td>
                        <td>
                            {% if rfq[12] %}
                                <a href="{{ url_for('show_comparison', ref=rfq[12]) }}">{{ rfq[12] }}</a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ rfq[2] }}</td><td>{{ rfq[4] }}</td><td>{{ rfq[5] }}</td>
                        <td>{{ rfq[6] }}</td><td>{{ rfq[7] }}</td><td>{{ rfq[8] }}</td>
                        <td>{{ rfq[9] }}</td><td>{{ rfq[11] }}</td>
                        <td class="action-buttons">
                            <a href="{{ url_for('edit_rfq', rfq_id=rfq[0]) }}" class="btn btn-warning btn-sm" title="Edit RFQ"><i class="fas fa-edit"></i></a>
                            <a href="{{ url_for('quotation_builder') }}?project_name={{ rfq[2] }}&rfq_ref={{ rfq[1] }}" class="btn btn-primary btn-sm" title="Submit Quote"><i class="fas fa-file-invoice-dollar"></i></a>
                            <button class="btn btn-info btn-sm" title="Comments" onclick="openCommentModal({{ rfq[0] }}, '{{ rfq[1] }}')">
                                <i class="fas fa-comments"></i>
                            </button>
                            {% if user_role == 'Technical Team Leader' %}
                                <form method="POST" action="{{ url_for('delete_rfq', rfq_id=rfq[0]) }}" onsubmit="return confirm('Are you sure you want to delete this RFQ? This action cannot be undone.');">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Delete RFQ">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="11" class="text-center text-muted py-5">No RFQs found matching your criteria.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel"><i class="fas fa-comments mr-2"></i>RFQ Comments - <span id="modalRfqReference"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Comment History -->
                <div class="mb-4">
                    <h6 class="font-weight-bold mb-3">Comment History</h6>
                    <div id="commentHistory" class="comment-history">
                        <p class="text-muted text-center">Loading comments...</p>
                    </div>
                </div>

                <!-- Add Comment Form -->
                <form id="commentForm" method="POST">
                    <div class="form-group">
                        <label for="commentText" class="font-weight-bold">Add New Comment</label>
                        <textarea class="form-control" id="commentText" name="comment" rows="4" placeholder="Enter your follow-up comment here..." required></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane mr-1"></i>Submit Comment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    Chart.register(ChartDataLabels);
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('rfqStatusChart').getContext('2d');
        const rfqStatusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: {{ status_labels|tojson }},
                datasets: [{
                    data: {{ status_counts|tojson }},
                    backgroundColor: ['#007bff', '#ffc107', '#28a745', '#dc3545', '#6c757d'],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        formatter: (value) => value > 0 ? value : null,
                        color: '#fff',
                        font: { weight: 'bold' }
                    },
                    legend: { position: 'bottom' }
                }
            }
        });
    });
    
    // RFQ Comments Modal Functions
    let currentRfqId = null;

    function openCommentModal(rfqId, rfqReference) {
        currentRfqId = rfqId;
        document.getElementById('modalRfqReference').textContent = rfqReference;
        document.getElementById('commentForm').action = `/add_rfq_comment/${rfqId}`;
        document.getElementById('commentText').value = '';
        
        // Load existing comments
        loadComments(rfqId);
        
        $('#commentModal').modal('show');
    }

    function loadComments(rfqId) {
        const historyDiv = document.getElementById('commentHistory');
        historyDiv.innerHTML = '<p class="text-muted text-center">Loading comments...</p>';
        
        fetch(`/get_rfq_comments/${rfqId}`)
            .then(response => response.json())
            .then(data => {
                if (data.comments && data.comments.length > 0) {
                    let html = '';
                    data.comments.forEach(comment => {
                        html += `
                            <div class="comment-item">
                                <div class="comment-header">
                                    <i class="fas fa-user-circle mr-1"></i>${comment.username}
                                    <span class="comment-time float-right">
                                        <i class="fas fa-clock mr-1"></i>${comment.created_at}
                                    </span>
                                </div>
                                <div class="comment-text">${comment.comment}</div>
                            </div>
                        `;
                    });
                    historyDiv.innerHTML = html;
                } else {
                    historyDiv.innerHTML = '<p class="text-muted text-center"><i class="fas fa-info-circle mr-1"></i>No comments yet. Be the first to add a comment!</p>';
                }
            })
            .catch(error => {
                console.error('Error loading comments:', error);
                historyDiv.innerHTML = '<p class="text-danger text-center"><i class="fas fa-exclamation-triangle mr-1"></i>Error loading comments. Please try again.</p>';
            });
    }
</script>
{% endblock %}
