{% extends 'base.html' %}
{% block title %}Submit New Quotation{% endblock %}

{% block content %}
<style>
    .card { border: none; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07); }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 600; font-size: 1.25rem; padding: 1.5rem; }
    .card-body { padding: 2rem; }
    .form-control:read-only { background-color: #e9ecef; }
</style>

<div class="container" style="max-width: 900px;">
    <div class="card">
        <div class="card-header"><i class="fas fa-file-invoice-dollar mr-2"></i>Submit New Quotation</div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                
                {% if prefill_data.project_name %}
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" class="form-control" name="project_name" value="{{ prefill_data.project_name }}" readonly>
                    </div>
                    <div class="form-group">
                        <label>RFQ Reference (from Link)</label>
                        <input type="text" class="form-control" name="rfq_reference" value="{{ prefill_data.rfq_reference }}" readonly>
                    </div>
                {% else %}
                    <div class="form-group">
                        <label for="project_name_select">Project Name</label>
                        <select class="form-control" name="project_name" id="project_name_select" required>
                            <option value="">Select Project...</option>
                            {% for project in projects %}
                                <option value="{{ project }}">{{ project }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="rfq_reference_auto">RFQ Reference (Auto-filled)</label>
                        <input type="text" class="form-control" name="rfq_reference" id="rfq_reference_auto" readonly>
                    </div>
                {% endif %}

                <div class="form-group">
                    <label for="quote_ref">Quote Reference (Manual)</label>
                    <input type="text" class="form-control" id="quote_ref" name="quote_ref" required>
                </div>
                <hr class="my-4">

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="presale_engineer">Presale Engineer</label>
                        {% if prefill_data.presale_engineer %}
                            <input type="text" class="form-control" name="presale_eng" value="{{ prefill_data.presale_engineer }}" readonly>
                        {% else %}
                            <select class="form-control" name="presale_eng" id="presale_engineer">
                                <option value="">Select an engineer...</option>
                                {% for engineer in presale_engineers %}
                                    <option value="{{ engineer }}">{{ engineer }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>
                    <div class="form-group col-md-6">
                        <label for="sales_engineer">Sales Engineer</label>
                        {% if prefill_data.sales_engineer %}
                             <input type="text" class="form-control" name="sales_eng" value="{{ prefill_data.sales_engineer }}" readonly>
                        {% else %}
                            <select class="form-control" name="sales_eng" id="sales_engineer">
                                <option value="">Select an engineer...</option>
                                {% for engineer in sales_engineers %}
                                    <option value="{{ engineer }}">{{ engineer }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label for="status-select">Status</label>
                    <select class="form-control" name="status" id="status-select">
                        {% for option in status_options %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="progress">Progress (Probability %)</label>
                    <textarea class="form-control" name="progress" id="progress" readonly></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6"><label for="system">System</label><input type="text" class="form-control" id="system" name="system" required></div>
                    <div class="form-group col-md-6"><label for="sow">SOW</label><input type="text" class="form-control" id="sow" name="sow" required></div>
                </div>
                <div class="form-row">
                     <div class="form-group col-md-6"><label for="quotation_cost">Quotation Cost</label><input type="number" step="0.01" class="form-control" id="quotation_cost" name="quotation_cost" required></div>
                     <div class="form-group col-md-6"><label for="quotation_selling_price">Quotation Selling Price</label><input type="number" step="0.01" class="form-control" id="quotation_selling_price" name="quotation_selling_price" required></div>
                </div>
                 <div class="form-group"><label for="quotation_note">Quotation Note</label><textarea class="form-control" id="quotation_note" name="quotation_note" rows="3"></textarea></div>
                <div class="form-group"><label for="feedback">Feedback</label><textarea class="form-control" id="feedback" name="feedback" rows="3"></textarea></div>
                <hr class="my-4">
                <div class="form-row">
                    <div class="form-group col-md-6"><label for="quotation">Upload Quotation</label><input type="file" class="form-control-file" id="quotation" name="quotation" required></div>
                    <div class="form-group col-md-6"><label for="cost_sheet">Upload Cost Sheet</label><input type="file" class="form-control-file" id="cost_sheet" name="cost_sheet" required></div>
                </div>

                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-paper-plane mr-2"></i>Submit</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectSelect = document.getElementById('project_name_select');
        const statusSelect = document.getElementById('status-select');
        const progressTextarea = document.getElementById('progress');

        const statusProbabilityMap = {
            'Quotation Sent': 5.00,
            'Customer Pending': 2.00,
            'Technical Discussion': 50.00,
            'Negotiation': 70.00,
            'Closed Won': 100.00,
            'Closed Lost': 0.00,
            'Cancelled': 0.00
        };

        // This logic only runs if the project dropdown exists and is interactive
        if (projectSelect) {
            projectSelect.addEventListener('change', function() {
                const projectName = this.value;
                const rfqField = document.getElementById('rfq_reference_auto');
                const presaleField = document.getElementById('presale_engineer');
                const salesField = document.getElementById('sales_engineer');

                if (!projectName) {
                    rfqField.value = '';
                    presaleField.value = '';
                    salesField.value = '';
                    return;
                };

                fetch(`/get_project_details/${projectName}`)
                    .then(response => response.json())
                    .then(data => {
                        rfqField.value = data.rfq_reference || '';
                        presaleField.value = data.presale_engineer || '';
                        salesField.value = data.sales_engineer || '';
                    })
                    .catch(error => console.error('Error:', error));
            });
        }

        // Logic to update Progress when Status is selected
        statusSelect.addEventListener('change', function() {
            const selectedStatus = this.value;
            const probability = statusProbabilityMap[selectedStatus];
            if (probability !== undefined) {
                progressTextarea.value = `${probability.toFixed(2)}%`;
            } else {
                progressTextarea.value = '';
            }
        });

        // Trigger the change event on page load to set the initial probability
        statusSelect.dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}