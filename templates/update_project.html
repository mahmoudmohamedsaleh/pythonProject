{% extends 'base.html' %}
{% block title %}Update Quotation{% endblock %}

{% block content %}
<style>
    .card { border: none; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07); }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 600; font-size: 1.25rem; padding: 1.5rem; }
    .card-body { padding: 2rem; }
    .form-control:read-only { background-color: #e9ecef; }
</style>

<div class="container" style="max-width: 900px;">
    <div class="card">
        <div class="card-header"><i class="fas fa-edit mr-2"></i>Update Quotation Details</div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Project Name</label>
                        <input type="text" class="form-control" name="project_name" value="{{ project['project_name'] }}" readonly>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Quote Reference</label>
                        <input type="text" class="form-control" value="{{ project['quote_ref'] }}" readonly>
                    </div>
                </div>
                <hr class="my-4">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="presale_eng">Presale Engineer</label>
                        <select class="form-control" id="presale_eng" name="presale_eng">
                            {% for engineer in presale_engineers %}
                                <option value="{{ engineer.username }}" {% if engineer.username == project['presale_eng'] %}selected{% endif %}>{{ engineer.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="sales_eng">Sales Engineer</label>
                        <select class="form-control" id="sales_eng" name="sales_eng">
                            {% for engineer in sales_engineers %}
                                <option value="{{ engineer.username }}" {% if engineer.username == project['sales_eng'] %}selected{% endif %}>{{ engineer.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="status-select">Status</label>
                    <select class="form-control" id="status-select" name="status">
                        {% for option in status_options %}
                            <option value="{{ option }}" {% if option == project['status'] %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="progress">Progress (Probability %)</label>
                    <textarea class="form-control" name="progress" id="progress" readonly>{{ project['progress'] }}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6"><label for="system">System</label><input type="text" class="form-control" id="system" name="system" value="{{ project['system'] }}" required></div>
                    <div class="form-group col-md-6"><label for="sow">SOW</label><input type="text" class="form-control" id="sow" name="sow" value="{{ project['sow'] }}" required></div>
                </div>
                <div class="form-row">
                     <div class="form-group col-md-6"><label for="quotation_cost">Quotation Cost</label><input type="number" step="0.01" class="form-control" id="quotation_cost" name="quotation_cost" value="{{ project['quotation_cost'] }}" required></div>
                     <div class="form-group col-md-6"><label for="quotation_selling_price">Quotation Selling Price</label><input type="number" step="0.01" class="form-control" id="quotation_selling_price" name="quotation_selling_price" value="{{ project['quotation_selling_price'] }}" required></div>
                </div>
                <div class="form-group"><label for="quotation_note">Quotation Note</label><textarea class="form-control" id="quotation_note" name="quotation_note" rows="3">{{ project['quotation_note'] }}</textarea></div>
                <div class="form-group"><label for="feedback">Feedback</label><textarea class="form-control" id="feedback" name="feedback" rows="3">{{ project['feedback'] }}</textarea></div>
                
                <hr class="my-4">
                <h5>Update Files (Optional)</h5>
                <p class="text-muted small">Only select a new file if you want to replace the existing one.</p>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="updated_quotation">Upload New Quotation</label>
                        <input type="file" class="form-control-file" id="updated_quotation" name="updated_quotation">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="updated_cost_sheet">Upload New Cost Sheet</label>
                        <input type="file" class="form-control-file" id="updated_cost_sheet" name="updated_cost_sheet">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save mr-2"></i>Update</button>
                <a href="{{ url_for('project_summary') }}" class="btn btn-secondary mt-3">Cancel</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('status-select');
        const progressTextarea = document.getElementById('progress');

        const statusProbabilityMap = {
            'Quotation Sent': 5.00,
            'Customer Pending': 2.00,
            'Technical Discussion': 50.00,
            'Negotiation': 70.00,
            'Closed Won': 100.00,
            'Closed Lost': 0.00,
            'Cancelled': 0.00
        };

        function updateProbability() {
            const selectedStatus = statusSelect.value;
            const probability = statusProbabilityMap[selectedStatus];
            if (probability !== undefined) {
                progressTextarea.value = `${probability.toFixed(2)}%`;
            } else {
                progressTextarea.value = '';
            }
        }

        // Listen for changes on the status dropdown
        statusSelect.addEventListener('change', updateProbability);

        // Run once on page load to set the initial value
        updateProbability();
    });
</script>
{% endblock %}