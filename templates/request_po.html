{% extends 'base.html' %}
{% block title %}Request Purchase Order{% endblock %}

{% block content %}
<style>
    .card { border: none; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.07); }
    .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 600; font-size: 1.25rem; padding: 1.5rem; }
    .card-body { padding: 2rem; }
    .form-control:read-only { background-color: #e9ecef; }
    .badge-pending { background-color: #ffc107; color: #000; }
</style>

<div class="container" style="max-width: 900px;">
    <div class="card">
        <div class="card-header">
            <i class="fas fa-shopping-cart mr-2"></i>Request Purchase Order
            <span class="badge badge-info float-right">Requires Approval</span>
        </div>
        <div class="card-body">
            <form method="post">
                <!-- Auto-filled from Quotation -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    The following information is auto-filled from the quotation. This PO request will be sent to Technical Team Leader or General Manager for approval.
                </div>

                <h5 class="mt-4 mb-3">Quotation Details (Auto-filled)</h5>
                
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" class="form-control" name="project_name" value="{{ quotation['project_name'] }}" readonly required>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Quote Reference</label>
                        <input type="text" class="form-control" name="quote_ref" value="{{ quotation['quote_ref'] }}" readonly required>
                    </div>
                    <div class="form-group col-md-6">
                        <label>System</label>
                        <input type="text" class="form-control" name="system" value="{{ quotation['system'] or 'N/A' }}" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Presale Engineer</label>
                        <input type="text" class="form-control" name="presale_engineer" value="{{ quotation['presale_eng'] }}" readonly required>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Project Manager (Optional)</label>
                        <select class="form-control" name="project_manager">
                            <option value="">Select Project Manager...</option>
                            {% for pm in project_managers %}
                                <option value="{{ pm['username'] }}">{{ pm['username'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="mb-3">Supplier Information (Required)</h5>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Distributor <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <select class="form-control" name="distributor_id" id="distributor_id" required onchange="updateDistributorName()">
                                <option value="">Select Distributor...</option>
                                {% for dist in distributors %}
                                    <option value="{{ dist['id'] }}" data-name="{{ dist['name'] }}">{{ dist['name'] }}</option>
                                {% endfor %}
                            </select>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-success" onclick="showAddDistributorModal()" title="Add New Distributor">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="distributor_name" id="distributor_name">
                    </div>
                    <div class="form-group col-md-6">
                        <label>Vendor (Optional)</label>
                        <div class="input-group">
                            <select class="form-control" name="vendor_id" id="vendor_id" onchange="updateVendorName()">
                                <option value="">Select Vendor...</option>
                                {% for vendor in vendors %}
                                    <option value="{{ vendor['id'] }}" data-name="{{ vendor['name'] }}">{{ vendor['name'] }}</option>
                                {% endfor %}
                            </select>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-success" onclick="showAddVendorModal()" title="Add New Vendor">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="vendor_name" id="vendor_name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Request Notes</label>
                    <textarea class="form-control" name="notes" rows="4" placeholder="Add any additional notes for the approvers..."></textarea>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('project_summary') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane"></i> Submit PO Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Distributor Modal -->
<div class="modal fade" id="addDistributorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-building"></i> Add New Distributor</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addDistributorForm">
                    <div class="form-group">
                        <label>Distributor Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="new_distributor_name" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" id="new_distributor_contact">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="new_distributor_phone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="new_distributor_email">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" id="new_distributor_address" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitDistributor()">
                    <i class="fas fa-save"></i> Add Distributor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Vendor Modal -->
<div class="modal fade" id="addVendorModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-truck"></i> Add New Vendor</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addVendorForm">
                    <div class="form-group">
                        <label>Vendor Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="new_vendor_name" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" class="form-control" id="new_vendor_contact">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" class="form-control" id="new_vendor_phone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="new_vendor_email">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" id="new_vendor_address" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitVendor()">
                    <i class="fas fa-save"></i> Add Vendor
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function updateDistributorName() {
    const select = document.getElementById('distributor_id');
    const selectedOption = select.options[select.selectedIndex];
    const distributorName = selectedOption.getAttribute('data-name') || '';
    document.getElementById('distributor_name').value = distributorName;
}

function updateVendorName() {
    const select = document.getElementById('vendor_id');
    const selectedOption = select.options[select.selectedIndex];
    const vendorName = selectedOption.getAttribute('data-name') || '';
    document.getElementById('vendor_name').value = vendorName;
}

function showAddDistributorModal() {
    $('#addDistributorModal').modal('show');
}

function showAddVendorModal() {
    $('#addVendorModal').modal('show');
}

function submitDistributor() {
    const name = document.getElementById('new_distributor_name').value.trim();
    
    if (!name) {
        alert('Distributor name is required!');
        return;
    }

    const data = {
        name: name,
        contact_person: document.getElementById('new_distributor_contact').value,
        phone: document.getElementById('new_distributor_phone').value,
        email: document.getElementById('new_distributor_email').value,
        address: document.getElementById('new_distributor_address').value
    };

    fetch('/add_distributor_ajax', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // Add new option to the dropdown
            const select = document.getElementById('distributor_id');
            const newOption = document.createElement('option');
            newOption.value = result.id;
            newOption.textContent = result.name;
            newOption.setAttribute('data-name', result.name);
            select.appendChild(newOption);
            
            // Select the newly added distributor
            select.value = result.id;
            updateDistributorName();
            
            // Close modal and reset form
            $('#addDistributorModal').modal('hide');
            document.getElementById('addDistributorForm').reset();
            
            alert('Distributor added successfully!');
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the distributor.');
    });
}

function submitVendor() {
    const name = document.getElementById('new_vendor_name').value.trim();
    
    if (!name) {
        alert('Vendor name is required!');
        return;
    }

    const data = {
        name: name,
        contact_person: document.getElementById('new_vendor_contact').value,
        phone: document.getElementById('new_vendor_phone').value,
        email: document.getElementById('new_vendor_email').value,
        address: document.getElementById('new_vendor_address').value
    };

    fetch('/add_vendor_ajax', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // Add new option to the dropdown
            const select = document.getElementById('vendor_id');
            const newOption = document.createElement('option');
            newOption.value = result.id;
            newOption.textContent = result.name;
            newOption.setAttribute('data-name', result.name);
            select.appendChild(newOption);
            
            // Select the newly added vendor
            select.value = result.id;
            updateVendorName();
            
            // Close modal and reset form
            $('#addVendorModal').modal('hide');
            document.getElementById('addVendorForm').reset();
            
            alert('Vendor added successfully!');
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the vendor.');
    });
}
</script>
{% endblock %}
