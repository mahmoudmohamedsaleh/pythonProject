{% extends 'base.html' %}
{% block title %}PO Profile - {{ po_number }}{% endblock %}

{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .page-header h1 {
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    .page-header .badge {
        font-size: 1rem;
        padding: 0.5em 1em;
    }
    .info-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        transition: transform 0.2s;
    }
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .info-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        font-size: 1.1rem;
    }
    .stat-box {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .stat-box .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .stat-box .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
    }
    .items-table thead th {
        background-color: #667eea;
        color: white;
        border: none;
        font-weight: 600;
        white-space: nowrap;
    }
    .items-table tbody tr {
        transition: background-color 0.2s;
    }
    .items-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .delivery-status-delivered {
        background-color: #28a745;
        color: white;
    }
    .delivery-status-partial {
        background-color: #ffc107;
        color: #212529;
    }
    .delivery-status-not-delivered {
        background-color: #dc3545;
        color: white;
    }
    .action-btn {
        margin: 2px;
    }
    .timeline-item {
        border-left: 3px solid #667eea;
        padding-left: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -9px;
        top: 0;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #667eea;
        border: 3px solid white;
    }
    .vat-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
</style>

<div class="page-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1><i class="fas fa-file-invoice mr-2"></i>Purchase Order Profile</h1>
            <p class="mb-2">PO Number: <strong>{{ po_number }}</strong></p>
            <p class="mb-0">Project: <strong>{{ po.project_name }}</strong></p>
        </div>
        <div>
            {% if po.po_approval_status == 'Approved' %}
                <span class="badge badge-success badge-lg"><i class="fas fa-check-circle mr-1"></i>{{ po.po_approval_status }}</span>
            {% elif po.po_approval_status == 'Pending' %}
                <span class="badge badge-warning badge-lg"><i class="fas fa-clock mr-1"></i>{{ po.po_approval_status }}</span>
            {% else %}
                <span class="badge badge-danger badge-lg"><i class="fas fa-times-circle mr-1"></i>{{ po.po_approval_status }}</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="mb-3">
    <a href="{{ url_for('view_po_status') }}" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Back to PO List</a>
    <a href="{{ url_for('view_po_document', po_id=po.id, doc_type='po_document') }}" target="_blank" class="btn btn-info"><i class="fas fa-file-pdf mr-2"></i>View PO Document</a>
    <a href="{{ url_for('edit_po', po_id=po.id) }}" class="btn btn-warning"><i class="fas fa-edit mr-2"></i>Edit PO</a>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-md-8">
        <!-- PO Details Card -->
        <div class="card info-card">
            <div class="card-header">
                <i class="fas fa-info-circle mr-2"></i>Purchase Order Details
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>System:</strong> {{ po.system }}</p>
                        <p><strong>Distributor:</strong> {{ po.distributor }}</p>
                        <p><strong>Vendor:</strong> {{ po.vendor or 'N/A' }}</p>
                        <p><strong>Presale Engineer:</strong> {{ po.presale_engineer }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Project Manager:</strong> {{ po.project_manager }}</p>
                        <p><strong>Delivery Status:</strong> 
                            {% if 'Delivered' in po.po_delivery_status %}
                                <span class="badge badge-success">{{ po.po_delivery_status }}</span>
                            {% elif 'Placed' in po.po_delivery_status %}
                                <span class="badge badge-info">{{ po.po_delivery_status }}</span>
                            {% else %}
                                <span class="badge badge-light">{{ po.po_delivery_status }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Created:</strong> {{ po.created_at.split(' ')[0] if po.created_at else 'N/A' }}</p>
                    </div>
                </div>
                
                {% if po.po_notes_vendor or po.po_notes_client %}
                <hr>
                <div class="row">
                    {% if po.po_notes_vendor %}
                    <div class="col-md-6">
                        <p><strong>Vendor Notes:</strong></p>
                        <p class="text-muted" style="white-space: pre-wrap;">{{ po.po_notes_vendor }}</p>
                    </div>
                    {% endif %}
                    {% if po.po_notes_client %}
                    <div class="col-md-6">
                        <p><strong>Client Notes:</strong></p>
                        <p class="text-muted" style="white-space: pre-wrap;">{{ po.po_notes_client }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- VAT & Financial Summary Card -->
        <div class="card info-card">
            <div class="card-header">
                <i class="fas fa-calculator mr-2"></i>Financial Summary
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-label">Subtotal (Before VAT)</div>
                            <div class="stat-value">{{ "{:,.2f}".format(po.total_amount) }} SAR</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box" style="border-left-color: #ffc107;">
                            <div class="stat-label">VAT ({{ po.vat_percentage or 15 }}%)</div>
                            <div class="stat-value">{{ "{:,.2f}".format(po.vat_amount or (po.total_amount * (po.vat_percentage or 15) / 100)) }} SAR</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box" style="border-left-color: #28a745;">
                            <div class="stat-label">Total (With VAT)</div>
                            <div class="stat-value">{{ "{:,.2f}".format(po.total_with_vat or (po.total_amount * (1 + (po.vat_percentage or 15) / 100))) }} SAR</div>
                        </div>
                    </div>
                </div>
                
                <div class="vat-info mt-3">
                    <form method="POST" action="{{ url_for('update_po_vat', po_number=po_number) }}" class="form-inline">
                        <label class="mr-2"><strong>Update VAT Percentage:</strong></label>
                        <input type="number" name="vat_percentage" class="form-control mr-2" step="0.01" value="{{ po.vat_percentage or 15 }}" style="width: 100px;" required>
                        <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save mr-1"></i>Update VAT</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- PO Items Card -->
        <div class="card info-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-boxes mr-2"></i>Purchase Order Items</span>
                <button class="btn btn-success btn-sm" data-toggle="modal" data-target="#addItemModal">
                    <i class="fas fa-plus mr-1"></i>Add Item
                </button>
            </div>
            <div class="card-body p-0">
                {% if po_items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0 items-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Part Number</th>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Delivered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in po_items %}
                            <tr>
                                <td>{{ item.item_number }}</td>
                                <td><strong>{{ item.part_number or 'N/A' }}</strong></td>
                                <td>{{ item.description }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ "{:,.2f}".format(item.unit_price or 0) }}</td>
                                <td><strong>{{ "{:,.2f}".format(item.total_price or 0) }}</strong></td>
                                <td>{{ item.quantity_delivered or 0 }}</td>
                                <td>
                                    {% if item.delivery_status == 'Delivered' %}
                                        <span class="badge delivery-status-delivered">{{ item.delivery_status }}</span>
                                    {% elif item.delivery_status == 'Partial' %}
                                        <span class="badge delivery-status-partial">{{ item.delivery_status }}</span>
                                    {% else %}
                                        <span class="badge delivery-status-not-delivered">{{ item.delivery_status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning action-btn" onclick="editItem({{ item.id }}, '{{ item.part_number or '' }}', '{{ item.description }}', {{ item.quantity }}, {{ item.unit_price or 0 }}, {{ item.quantity_delivered or 0 }}, '{{ item.delivery_status }}', '{{ item.notes or '' }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <form method="POST" action="{{ url_for('delete_po_item', item_id=item.id) }}" style="display: inline;" onsubmit="return confirm('Delete this item?');">
                                        <button type="submit" class="btn btn-sm btn-danger action-btn" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">No items added yet.</p>
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addItemModal">
                        <i class="fas fa-plus mr-2"></i>Add First Item
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Delivery Notes History -->
        <div class="card info-card">
            <div class="card-header">
                <i class="fas fa-truck mr-2"></i>Delivery Notes History
            </div>
            <div class="card-body">
                {% if delivery_notes %}
                <div class="timeline">
                    {% for note in delivery_notes %}
                    <div class="timeline-item">
                        <h6 class="mb-1"><strong>{{ note.registration_date.split(' ')[0] if note.registration_date else 'N/A' }}</strong></h6>
                        <p class="mb-1"><strong>Status:</strong> {{ note.status }}</p>
                        {% if note.expected_delivery %}
                        <p class="mb-1"><strong>Expected Delivery:</strong> {{ note.expected_delivery }}</p>
                        {% endif %}
                        {% if note.notes %}
                        <p class="mb-1"><strong>Notes:</strong> {{ note.notes }}</p>
                        {% endif %}
                        {% if note.delivery_note %}
                        <a href="{{ url_for('view_document', entry_id=note.id, doc_type='delivery_note') }}" target="_blank" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-file-pdf mr-1"></i>View Delivery Note
                        </a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No delivery notes recorded yet.</p>
                {% endif %}
                <a href="{{ url_for('register_po_follow_up', po_number=po_number, total_amount=po.total_amount) }}" class="btn btn-primary btn-block mt-3">
                    <i class="fas fa-plus mr-2"></i>Add Delivery Note
                </a>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Quick Stats -->
        <div class="card info-card">
            <div class="card-header">
                <i class="fas fa-chart-bar mr-2"></i>Delivery Summary
            </div>
            <div class="card-body">
                <div class="stat-box">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value">{{ po_items|length }}</div>
                </div>
                <div class="stat-box" style="border-left-color: #28a745;">
                    <div class="stat-label">Delivered</div>
                    <div class="stat-value">{{ delivered_count }}</div>
                </div>
                <div class="stat-box" style="border-left-color: #ffc107;">
                    <div class="stat-label">Partial</div>
                    <div class="stat-value">{{ partial_count }}</div>
                </div>
                <div class="stat-box" style="border-left-color: #dc3545;">
                    <div class="stat-label">Not Delivered</div>
                    <div class="stat-value">{{ not_delivered_count }}</div>
                </div>
                {% if po_items|length > 0 %}
                <div class="progress mt-3" style="height: 25px;">
                    <div class="progress-bar bg-success" style="width: {{ (delivered_count / po_items|length * 100)|round(1) }}%">
                        {{ (delivered_count / po_items|length * 100)|round(1) }}%
                    </div>
                </div>
                <p class="text-center mt-2 mb-0 text-muted small">Delivery Progress</p>
                {% endif %}
            </div>
        </div>

        <!-- Contact Information -->
        <div class="card info-card">
            <div class="card-header">
                <i class="fas fa-address-book mr-2"></i>Distributor Contact
            </div>
            <div class="card-body">
                {% if po.distributor_engineer %}
                <p><strong>Contact Person:</strong><br>{{ po.distributor_engineer }}</p>
                {% endif %}
                {% if po.distributor_contact %}
                <p><strong>Phone:</strong><br>{{ po.distributor_contact }}</p>
                {% endif %}
                {% if po.distributor_email %}
                <p><strong>Email:</strong><br><a href="mailto:{{ po.distributor_email }}">{{ po.distributor_email }}</a></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle mr-2"></i>Add New Item</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" action="{{ url_for('add_po_item', po_number=po_number) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Part Number</label>
                                <input type="text" name="part_number" class="form-control" placeholder="Optional">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Quantity <span class="text-danger">*</span></label>
                                <input type="number" name="quantity" class="form-control" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description <span class="text-danger">*</span></label>
                        <textarea name="description" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Unit Price (SAR)</label>
                                <input type="number" name="unit_price" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Total Price (SAR)</label>
                                <input type="number" name="total_price" class="form-control" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save mr-1"></i>Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit mr-2"></i>Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="POST" id="editItemForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Part Number</label>
                                <input type="text" name="part_number" id="edit_part_number" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Quantity <span class="text-danger">*</span></label>
                                <input type="number" name="quantity" id="edit_quantity" class="form-control" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description <span class="text-danger">*</span></label>
                        <textarea name="description" id="edit_description" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Unit Price (SAR)</label>
                                <input type="number" name="unit_price" id="edit_unit_price" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Quantity Delivered</label>
                                <input type="number" name="quantity_delivered" id="edit_quantity_delivered" class="form-control" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Delivery Status <span class="text-danger">*</span></label>
                                <select name="delivery_status" id="edit_delivery_status" class="form-control" required>
                                    <option value="Not Delivered">Not Delivered</option>
                                    <option value="Partial">Partial</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Delivery Date</label>
                                <input type="date" name="delivery_date" id="edit_delivery_date" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea name="notes" id="edit_notes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-1"></i>Update Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editItem(id, part_number, description, quantity, unit_price, quantity_delivered, delivery_status, notes) {
    document.getElementById('editItemForm').action = `/edit_po_item/${id}`;
    document.getElementById('edit_part_number').value = part_number;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_quantity').value = quantity;
    document.getElementById('edit_unit_price').value = unit_price;
    document.getElementById('edit_quantity_delivered').value = quantity_delivered;
    document.getElementById('edit_delivery_status').value = delivery_status;
    document.getElementById('edit_notes').value = notes;
    $('#editItemModal').modal('show');
}
</script>
{% endblock %}
